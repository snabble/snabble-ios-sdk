<!doctype html>
<html lang="en">
<head>
    <title>Auto Credit Card Type Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <script type="text/javascript">
        // intercept errors
        window.onerror = (msg, url, line, column, error) => {
          const message = {
            message: msg,
            url: url,
            line: line,
            column: column,
            error: JSON.stringify(error)
          }

          window.webkit.messageHandlers.{{handler}}.postMessage(message);
        };

        // intercept console.log and console.debug
        window.console.log = function(msg) { window.webkit.messageHandlers.{{handler}}.postMessage(msg) }
        window.console.debug = function(msg) { window.webkit.messageHandlers.{{handler}}.postMessage(msg) }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.css">
    <!-- link rel="stylesheet" href="css/style.css" -->
    <style type="text/css">
        * {
            box-sizing: content-box;
        }

        .payone-cc-message-wrap {
            display: none;
        }

        .payone-cc-icon {
            margin: 10px;
            padding: 10px;
            width: auto;
            height: 30px;
            border: 2px solid transparent;
            border-radius: 5px;
        }

        .payone-cc-icon--clickable:hover {
            cursor: pointer;
        }

        .payone-cc-icon--selected {
            border-color: #0078AB;
        }

        .payone-input-mock {
            border: 2px solid #0078AB;
            border-radius: 10px;
            padding: 5px 15px;
            max-width: 200px;
        }

        .payone-input-mock iframe {
            height: 50px;
            width: 100%;
            vertical-align: middle;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
    <script src="https://secure.pay1.de/client-api/js/v1/payone_hosted.js"></script>
    <!-- script src="js/auto-cc-detection.js"></script -->
    <script type="text/javascript">
        console.log("payone form start");
        /**
         * The PAYONE auto card type detection class constructor.
         *
         * @param config The auto card type detection config.
         * @constructor
         */
        function PayoneAutoCcDetection(config)
        {
            console.log("PayoneAutoCcDetection " + config)
            // Apply config defaults.
            this._config = Object.assign({}, {
                iconsSelector: '.payone-cc-icon',
                iconClickableClass: 'payone-cc-icon--clickable',
                iconSelectedClass: 'payone-cc-icon--selected',
                messageSelector: '.payone-cc-message-wrap',
            }, config);

            // Setup auto credit card detection config.
            console.log("supported types: " + this._config.supportedCardTypes);
            this._config.hostedIframesConfig.config.autoCardtypeDetection = {
                deactivate: false,
                supportedCardtypes: this._config.supportedCardTypes,
                callback: this._handleDetectionResult.bind(this),
            };

            // Create hosted IFrames object.
            this._hostedIframe = new Payone.ClientApi.HostedIFrames(
                this._config.hostedIframesConfig.config,
                this._config.hostedIframesConfig.request
            );

            // Register credit card check callback.
            // The hosted IFrames API expects a callback provided as string,
            // therefore we cannot use a function value reference directly.
            // As a workaround we register the actual handler method as global
            // function with a random unique name which will be provided to the
            // hosted IFrames API later.
            this._creditCardCheckCallbackName = 'payone_cc_check_callback_' + Math.random().toString().substr(2);
            window[this._creditCardCheckCallbackName] = this._creditCardCheckCallback.bind(this);

            // Keeps state of manually set card type in fallback scenario.
            this._cardTypeSetManually = false;

            this._enableManualSelection();
        }

        /**
         * Returns the card brand icons jQuery element list.
         *
         * @returns {jQuery} The card brand icons jQuery element list.
         * @private
         */
        PayoneAutoCcDetection.prototype._$icons = function () {
            return $(this._config.iconsSelector);
        };

        /**
         * Returns the message jQuery element.
         *
         * @returns {jQuery} The message jQuery element.
         * @private
         */
        PayoneAutoCcDetection.prototype._$msg = function () {
            return $(this._config.messageSelector);
        };

        /**
         * Changes the current selected icon in accordance
         * to the provided type.
         *
         * @param {string} type The new card type.
         * @private
         */
        PayoneAutoCcDetection.prototype._changeIcon = function (type) {
            console.log("changeIcon " + type);
            this._$icons()
                .removeClass(this._config.iconSelectedClass)
                .filter('[data-cc-type="' + type + '"]')
                .addClass(this._config.iconSelectedClass);
        };

        /**
         * @todo remove
         * @private
         */
        PayoneAutoCcDetection.prototype._clearIconSelection = function () {
            console.log("clearIcon");
            this._$icons().removeClass(this._config.iconSelectedClass);
        };

        /**
         * Shows the provided message to the user.
         *
         * @param {string} level The message level.
         * @param {string} message The message text.
         * @private
         */
        PayoneAutoCcDetection.prototype._showMessage = function (level, message) {
            console.log("showMessage " + message);
            this._$msg()
                .find('.alert')
                .removeClass()
                .addClass('alert alert-' + level)
                .html(message);

            this._$msg().fadeIn(400);
        };

        /**
         * Hides any visible message.
         *
         * @private
         */
        PayoneAutoCcDetection.prototype._hideMessage = function () {
            console.log("hideMessage");
            this._$msg().fadeOut(200);
        };

        /**
         * Handles automatically detected card types.
         * This is the handler that will be called by the hosted iFrames API
         * if a card type detection result is available.
         *
         * @param {string} type The detection result of the hosted IFrames API.
         * @private
         */
        PayoneAutoCcDetection.prototype._handleDetectionResult = function (type) {
            console.log("handleDetection " + type);
            type = type.toUpperCase();

            // Delegate further processing to dedicated handlers.
            switch (type) {
                case '?':
                    this._handleUnknownCardType(type);
                    break;
                case '-':
                    this._handleUnsupportedCardType(type);
                    break;
                default:
                    this._handleValidCardType(type);
                    break;
            }
        };

        /**
         * Handles detection results of valid card types.
         *
         * @param {string} type The detected valid card type.
         * @private
         */
        PayoneAutoCcDetection.prototype._handleValidCardType = function (type) {
            console.log("handleValidCard " + type);
            this._changeIcon(type);
            this._hideMessage();

            // Disable manual selection if card type was not set manually already.
            if (!this._cardTypeSetManually) {
                this._disableManualSelection();
            }
        };

        /**
         * Handles unknown card type detection results.
         *
         * @private
         */
        PayoneAutoCcDetection.prototype._handleUnknownCardType = function () {
            console.log("handleUnknownCart");
            this._clearIconSelection();
            this._showMessage('warning', 'The card type cannot be detected automatically. Please specify your card type by clicking the corresponding icon.');
            this._enableManualSelection();
        };

        /**
         * Handles unsupported card type detection results.
         *
         * @private
         */
        PayoneAutoCcDetection.prototype._handleUnsupportedCardType = function () {
            console.log("handleUnsupportedType");
            this._clearIconSelection();
            this._showMessage('danger', 'The card type is not supported. Please specify a card type corresponding to the icon brands above.');

            // Disable manual selection if card type was not set manually already.
            if (!this._cardTypeSetManually) {
                this._disableManualSelection();
            }
        };

        /**
         * Renders the credit card check response.
         *
         * @param {object} response
         * @private
         */
        PayoneAutoCcDetection.prototype._renderResponse = function (response) {
            console.log("renderResponse");
            $('#cc-check-response-wrap pre').html(JSON.stringify(response, null, 2));
        };

        /**
         * Enables the manual selection of credit card types.
         *
         * @private
         */
        PayoneAutoCcDetection.prototype._enableManualSelection = function () {
            console.log("enableManualSelection");
            var _this = this;

            this._$icons()
                .addClass(this._config.iconClickableClass)
                .on('click.payone', function () {
                    console.log("manualSelection click");
                    var type = $(this).data('ccType').toUpperCase();
                    _this._cardTypeSetManually = true;
                    _this._hostedIframe.setCardType(type);
                    _this._changeIcon(type);
                    _this._hideMessage();
                });
        };

        /**
         * Disables the manual selection of credit card types.
         *
         * @private
         */
        PayoneAutoCcDetection.prototype._disableManualSelection = function () {
            console.log("disableManualSelection");
            this._$icons()
                .removeClass(this._config.iconClickableClass)
                .off('click.payone');
        };

        /**
         * Handles the credit card check result.
         *
         * @param {object} response The credit card check result from the hosted IFrame API.
         * @private
         */
        PayoneAutoCcDetection.prototype._creditCardCheckCallback = function (response) {
            console.log("checkCallback" + response);
            this._renderResponse(response);

            switch (response.status) {
                case 'VALID':
                    this._showMessage('success', 'Success! Credit card check was valid.');
                    break;
                case 'INVALID':
                case 'ERROR':
                    this._showMessage('danger', 'Error ' + response.errorcode + ': ' + response.errormessage);
                    break;
                default:
                    this._showMessage('warning', 'API returned an unexpected status.');
                    break;
            }
        };

        /**
         * Performs the credit card check.
         */
        PayoneAutoCcDetection.prototype.performCreditCardCheck = function () {
            console.log("performCheck");
            if (this._hostedIframe.isComplete()) {
                console.log("complete!");
                this._hostedIframe.creditCardCheck(this._creditCardCheckCallbackName);
            }
            else {
                console.log("incomplete :(");
                this._showMessage('danger', 'Please fill out the form completely.');
            }
        };

    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col py-5">
                <!-- h1 class="h2">Auto Credit Card Type Detection Example</h1 -->

                <!-- HTML for displaying CC detection messages. -->
                <div class="payone-cc-message-wrap my-3">
                    <div class="alert alert-success" role="alert"></div>
                </div>

                <!-- Render the CC icons based on supported card types -->
                <div class="payone-cc-icons-wrap my-5">
                    <img
                            class="payone-cc-icon payone-cc-icon--clickable"
                            src="https://cdn.pay1.de/cc/v/l/default.png"
                            alt="V Icon"
                            data-cc-type="V"
                        >
                    <img
                            class="payone-cc-icon  payone-cc-icon--clickable"
                            src="https://cdn.pay1.de/cc/m/l/default.png"
                            alt="M Icon"
                            data-cc-type="M"
                        >
                </div>

                <!-- The form HTML with IFrame fields. -->
                <form id="cc-form" class="my-3" action="#" method="post">
                    <div class="form-group">
                        <label for="payone-cc-pan">Card Number</label>
                        <div class="payone-input-mock payone-input-mock--pan">
                            <!-- Mount element for PAN IFrame. -->
                            <span id="payone-cc-pan"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-cvc">CVC</label for="payone-cc-cvc">
                        <div class="payone-input-mock payone-input-mock--cvc">
                            <!-- Mount element for CVC IFrame. -->
                            <span id="payone-cc-cvc"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-expire-month">Expire Month (MM)</label>
                        <div class="payone-input-mock payone-input-mock--expire-month">
                            <!-- Mount element for card expire month IFrame. -->
                            <span id="payone-cc-expire-month"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payone-cc-expire-year">Expire Year (YYYY)</label>
                        <div class="payone-input-mock payone-input-mock--expire-year">
                            <!-- Mount element for card expire year IFrame. -->
                            <span id="payone-cc-expire-year"></span>
                        </div>
                    </div>

                    <div class="form-group mt-5">
                        <button id="submit" class="btn btn-primary btn-lg" type="button">Perform CC Check</button>
                    </div>
                </form>

                <hr class="my-5">

                <!-- HTML to render the credit card check response. -->
                <h2 class="h4">Credit Card Check Response</h2>
                <div id="cc-check-response-wrap">
                    <pre></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var autoCcDetection = new PayoneAutoCcDetection({
                supportedCardTypes: ["V","M"],
                hostedIframesConfig: {
                    config: {
                        fields: {
                            cardpan: {
                                selector: "payone-cc-pan",
                                type: "input"
                            },
                            cardcvc2: {
                                selector: "payone-cc-cvc",
                                type: "password",
                                size: "4",
                                maxlength: "4",
                                length: { "V": 3, "M": 3 }
                            },
                            cardexpiremonth: {
                                selector: "payone-cc-expire-month",
                                type: "text",
                                size: "2",
                                maxlength: "2",
                            },
                            cardexpireyear: {
                                selector: "payone-cc-expire-year",
                                type: "text",
                            }
                        },
                        defaultStyle: {
                            input: "height: 100%; width: 100%; border: none; font-size: 20px; letter-spacing: 1px;",
                            iframe: {},
                        },

                        language: Payone.ClientApi.Language.en,
                    },
                    request: {
                        "responsetype":"JSON",
                        "encoding":"UTF-8",
                        "mode":"{{mode}}",
                        "request":"creditcardcheck",
                        "storecarddata":"yes",
                        "mid":"{{merchantID}}",
                        "aid":"{{accountID}}",
                        "portalid":"{{portalID}}",
                        "hash":"{{hash}}"
                    }
                },
            });

            document.querySelector('#submit').addEventListener('click', function (event) {
                event.preventDefault();
                console.log('click!');
                autoCcDetection.performCreditCardCheck();
            });
        })();
    </script>
</body>
</html>

